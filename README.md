# luatos-utils

This project provide a set of utils and scripts to compile and generate the script.bin and script.img for LuatOS with OpenLuat AIR101 / AIR103 Soc / Devboards.

For a complete tutorial, refer to : https://github.com/cjacker/opensource-toolchain-w80x-air101-air103

**NOTE :** there is no plan to support AIR105, AIR105 and MH1903S is identical and based on ARM core. Since it didn't export SWD interface, without modify the hardware of AIR105 devboard, there is no way to program it with CMSIS-DAP, Jlink, ST-Link, etc. Either you switch to Windows, or you can use [air105-uploader](https://github.com/racerxdl/air105-uploader) with [mh1903s firmware library](https://github.com/cjacker/mh1903_firmware_library_gcc_makefile) instead.

## Build
Type `make` to build the project. `luatos-mkscriptbin` and `luatos-wm_tool` had no external dependencies, `luac` will be built as 32bit elf and requires some 32bit libraries and development packages, such as readline, please install it according to your distribution.

After built successfully, `luatos-luac` / `luatos-mkscriptbin` and `luatos-wm_tool` will be generated at current dir, and will be used by `luatos-gen-script-img` and `luatos-flash-script-img`.

## Install
You can use all scripts in current dir without installation, if you want to install it to system wide :

```
sudo make install DESTDIR=<DEST DIR>
```

## Usage
- create a `src` dir, put lua sources and other resources into it.
- run `luatos-gen-script-img [air101|air103] src_dir` to generate `script.img` for air101 or air103.
- run `luatos-flash-script-img [air101|air103] <script.img>` to program `script.img` to air101 or air103.

This `script.img` can also be append to LuatOS base firmware and generate a whole img, such as:
```
cat script.img >>AIR101.fls
```

And program to target device as:
```
luatos-wm_tool -ds 2M -c ttyUSB0 -ws 115200 -rs rts -dl AIR101.fls
```
Or
```
luatos-flash-base-firmware AIR101.fls
```

## LuatOS Base firmware

[LuatOS](https://github.com/openLuat/LuatOS) is a powerful embedded Lua engine for IoT devices with many components.

Usually, LuatOS release a base firmware for several SOCs, you can download it from [LuatOS project](https://gitee.com/openLuat/LuatOS/releases). base firmware works as a fundamental platform which can support run lua scripts in luadb format (generated by mkscriptbin of this project).

- For AIR101 : https://gitee.com/openLuat/LuatOS/releases/download/v0007.air101.v0015/core_V0015.zip
- For AIR103 : https://gitee.com/openLuat/LuatOS/releases/download/v0007.air103.v0015/core_V0015.zip

Using air101 firmware as example, after extracted, you will find a `LuatOS-SoC_V0015_AIR101.soc` file, it's 7z files and can be extracted by:

```
7za x LuatOS-SoC_V0015_AIR101.soc
```

After extracted, `AIR101.fls` is the 'base firmware' you can program to AIR101 devboards as :
```
luatos-wm_tool -ds 2M -c ttyUSB0 -ws 115200 -rs rts -dl AIR101.fls
```

Or 
```
luatos-flash-base-firmware AIR101.fls
```

Air103 is as same as Air101, but the default demo in this project use LVGL, if you want to use this demo, you should extract the `LuatOS-SoC_VERSION_AIR103_LVGL.soc` to get 'AIR103.fls'.


## UART connection
After script.img programmed, you can use below commands to connect to devboard via UART:

```
tio -b 921600 /dev/ttyUSB0 -m INLCRNL
```
Or

```
picocom -b 921600 /dev/ttyUSB0 --imap spchex,lfcrlf
```

## RTS behavior

Open serial port will cause target device RESET with Linux (Windows will not). If your devboards has RTS or DTR pin connect to RESET pin of the chip, every time the serial port opened, it will reset target device.

Refer to [https://stackoverflow.com/questions/5090451/how-to-open-serial-port-in-linux-without-changing-any-pin](https://stackoverflow.com/questions/5090451/how-to-open-serial-port-in-linux-without-changing-any-pin) for more info.

For LuatOS, it heavily depend on UART log for debugging and monitoring, everytime the serial port opened, it will reset the target device. this hehavior is unacceptable.

For Air 101 and 103 board, there is CH34X UART chip on board, we can change this behavior by modify the driver source code.

You can download the `ch341.c` from `drivers/usb/serial/ch341.c` of upstream kernel, and find `ch341_dtr_rts` function, comment out all contents of this function and put it in `ch341-mod` dir.

Then type `make` to build the new driver, it will rename the driver to `ch341-uart.ko`. you can :
- either blacklist original `ch341.ko` and install this new driver.
- or `sudo rmmod ch341.ko && insmod ./ch341-kmod/ch341-uart.ko` everytime you need it.
 
## Dir structure
```
luatos-utils
├── ch341-mod
│   ├── ch341.c
│   └── Makefile
├── luatos-flash-base-firmware : a script to flash upstream base firmware to air101 / 103
├── luatos-flash-script-img : a script to flash script.img to air101 / 103
├── luatos-gen-script-img : a script to generate script.img for air101 / 103
├── LICENSE
├── lvgl-demo : LVGL button demo project works with AIR 101 / 103 and OpenLuat LCD panel.
├── blink-demo : LED blink demo project works with AIR 101 / 103 devboard.
├── Makefile : build all related utils
├── README.md : this file
└── utils
    ├── lua-5.3.6.tar.gz : upstream lua 5.3.6 tarball, used to build 32bit luac
    ├── mkscriptbin.c : source of mkscriptbin, a tool to generate script.bin in luadb format
    └── wm_tool_mod_by_luatos.c : source of air101 / 103 firmware convert and flash tool
```
